<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机抽取人名</title>
    
    <!-- 强制使用 HTTPS -->
    <script>
    if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
        window.location.href = window.location.href.replace('http:', 'https:');
    }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <script>
    // 全局变量和常量声明
    const INITIAL_NAMES = [
        { name: "梁晓珍", avatar: "assets/avatars/梁晓珍.png" },
        { name: "常鸿祥", avatar: "assets/avatars/常鸿祥.png" },
        { name: "韩烁", avatar: "assets/avatars/韩烁.png" },
        { name: "荆文姗", avatar: "assets/avatars/荆文姗.png" },
        { name: "励艳丽", avatar: "assets/avatars/励艳丽.png" },
        { name: "吕飞", avatar: "assets/avatars/吕飞.png" },
        { name: "邱宇宁", avatar: "assets/avatars/邱宇宁.png" },
        { name: "任蒙龙", avatar: "assets/avatars/任蒙龙.png" },
        { name: "王耀旭", avatar: "assets/avatars/王耀旭.png" },
        { name: "喻言", avatar: "assets/avatars/喻言.png" },
        { name: "张华珍", avatar: "assets/avatars/张华珍.png" },
        { name: "张小莲", avatar: "assets/avatars/张小莲.png" }
    ];
    
    const DB_NAME = 'YaorenDB';
    const DB_VERSION = 1;
    const API_URL = '/api';
    const MAX_RETRIES = 3;
    const SYNC_INTERVAL = 1000;

    let names = [...INITIAL_NAMES];
    let usedNames = new Set();
    let isRolling = false;
    let rollInterval;
    let db;
    let retryCount = 0;
    let lastSyncTime = 0;

    // 常量
    const MAX_RETRIES = 3;
    const SYNC_INTERVAL = 1000; // 1秒的同步间隔

    // IndexedDB 配置
    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = (event) => {
                console.error('数据库错误:', event.target.error);
                reject(event.target.error);
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('数据库连接成功');
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // 创建存储对象
                if (!db.objectStoreNames.contains('gameState')) {
                    const store = db.createObjectStore('gameState', { keyPath: 'id' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('history')) {
                    const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    historyStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        });
    }

    // 保存状态到 IndexedDB
    async function saveToServer() {
        try {
            console.log('开始保存数据...');
            
            const currentResult = {
                name: document.querySelector('.result-name').textContent,
                avatar: document.getElementById('resultAvatar').src,
                display: document.getElementById('resultAvatar').style.display
            };

            const state = {
                id: 'current',
                names: names,
                usedNames: Array.from(usedNames),
                currentResult: currentResult,
                timestamp: Date.now(),
                version: '5.0'
            };

            const tx = db.transaction('gameState', 'readwrite');
            const store = tx.objectStore('gameState');
            await store.put(state);
            
            console.log('数据保存成功');
            updateSyncStatus('数据已保存');
            
        } catch (error) {
            console.error('保存失败:', error);
            updateSyncStatus('保存失败: ' + error.message);
            setTimeout(saveToServer, 3000);
        }
    }

    // 从 IndexedDB 加载状态
    async function loadFromServer() {
        try {
            const tx = db.transaction('gameState', 'readonly');
            const store = tx.objectStore('gameState');
            const request = store.get('current');
            
            return new Promise((resolve, reject) => {
                request.onsuccess = (event) => {
                    const data = event.target.result;
                    if (data) {
                        console.log('加载数据成功:', data);
                        names = data.names;
                        usedNames = new Set(data.usedNames);
                        
                        if (data.currentResult) {
                            updateResultDisplay(data.currentResult);
                        }
                        
                        updateLists();
                        updateSyncStatus('数据已同步');
                    }
                    resolve(data);
                };
                
                request.onerror = (event) => {
                    console.error('加载数据失败:', event.target.error);
                    reject(event.target.error);
                };
            });
        } catch (error) {
            console.error('加载失败:', error);
            updateSyncStatus('加载失败');
        }
    }

    // 保存抽取结果到历史记录
    async function saveResult(name, avatar) {
        try {
            const tx = db.transaction('history', 'readwrite');
            const store = tx.objectStore('history');
            
            await store.add({
                name: name,
                avatar: avatar,
                timestamp: Date.now()
            });
            
            updateSyncStatus('结果已保存');
            await loadHistory();  // 刷新历史记录显示
        } catch (error) {
            console.error('保存结果失败:', error);
            setTimeout(() => saveResult(name, avatar), 3000);
        }
    }

    // 加载历史记录
    async function loadHistory() {
        try {
            const tx = db.transaction('history', 'readonly');
            const store = tx.objectStore('history');
            const index = store.index('timestamp');
            
            const request = index.openCursor(null, 'prev');
            const results = [];
            
            return new Promise((resolve, reject) => {
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor && results.length < 10) {
                        results.push(cursor.value);
                        cursor.continue();
                    } else {
                        const historyList = document.getElementById('historyList');
                        if (historyList) {
                            historyList.innerHTML = '';
                            results.forEach(result => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                historyItem.innerHTML = `
                                    <img src="${result.avatar || 'assets/default-avatar.png'}" alt="${result.name}">
                                    <div>
                                        <div>${result.name}</div>
                                        <div class="time">${new Date(result.timestamp).toLocaleString('zh-CN')}</div>
                                    </div>
                                `;
                                historyList.appendChild(historyItem);
                            });
                        }
                        resolve(results);
                    }
                };
                
                request.onerror = (event) => {
                    console.error('加载历史记录失败:', event.target.error);
                    reject(event.target.error);
                };
            });
        } catch (error) {
            console.error('加载历史记录失败:', error);
        }
    }

    // 配置API地址
    const API_URL = '/api';

    // 添加错误处理和重试机制
    async function retryOperation(operation, errorMessage) {
        retryCount = 0;
        while (retryCount < MAX_RETRIES) {
            try {
                const result = await operation();
                retryCount = 0;  // 重置重试计数
                return result;
            } catch (error) {
                retryCount++;
                console.error(`${errorMessage} (尝试 ${retryCount}/${MAX_RETRIES}):`, error);
                if (retryCount === MAX_RETRIES) {
                    updateSyncStatus('同步失败，请检查网络连接');
                    throw error;
                }
                // 指数退避重试
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
            }
        }
    }

    // 优化数据加载
    async function loadFromServer() {
        const now = Date.now();
        if (now - lastSyncTime < SYNC_INTERVAL) {
            return; // 防止过于频繁的同步
        }
        
        try {
            // 创建查询
            const query = new AV.Query('GameState');
            query.descending('createdAt');
            query.limit(1);
            
            // 执行查询
            const result = await query.first();
            if (result) {
                const newNames = result.get('names');
                const newUsedNames = new Set(result.get('usedNames'));
                const currentResult = result.get('currentResult');
                
                // 检查是否有实际变化
                const namesChanged = JSON.stringify(names) !== JSON.stringify(newNames);
                const usedNamesChanged = JSON.stringify(Array.from(usedNames)) !== JSON.stringify(Array.from(newUsedNames));
                
                if (namesChanged || usedNamesChanged) {
                    names = newNames;
                    usedNames = newUsedNames;
                    
                    if (currentResult) {
                        updateResultDisplay(currentResult);
                    }
                    
                    updateLists();
                    updateSyncStatus('数据已更新');
                }
            }
            
            lastSyncTime = now;
        } catch (error) {
            console.error('同步失败:', error);
            updateSyncStatus('同步失败');
        }
    }

    // 优化结果显示更新
    function updateResultDisplay(resultData) {
        const resultAvatar = document.getElementById('resultAvatar');
        const resultName = document.querySelector('.result-name');
        
        if (resultData.name !== resultName.textContent) {
            resultName.textContent = resultData.name;
            if (resultData.avatar) {
                resultAvatar.src = resultData.avatar;
                resultAvatar.style.display = resultData.display;
            } else {
                resultAvatar.style.display = 'none';
            }
        }
    }

    // 优化页面加载初始化
    window.onload = async function() {
        try {
            // 初始化数据库
            await initDB();
            
            // 初始化界面
            initTheme();
            updateDateDisplay();
            setupDragAndDrop();
            
            // 加载数据
            await loadFromServer();
            await loadHistory();
            
            // 设置定期同步检查
            setInterval(loadFromServer, 1000);
            
            // 页面可见性变化监听
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    loadFromServer();
                }
            });
            
            console.log('页面初始化完成');
            
        } catch (error) {
            console.error('页面初始化失败:', error);
            alert('页面初始化失败，请刷新重试');
        }
    };

    // 从服务器加载状态
    async function loadStateFromServer() {
        try {
            const response = await fetch(`${API_URL}/state`);
            const state = await response.json();
            if (state && state.usedNames) {
                usedNames = new Set(state.usedNames);
                updateLists();
                updateResult(null);
            }
        } catch (error) {
            console.error('加载状态失败:', error);
        }
    }

    // 保存状态到服务器
    async function saveStateToServer() {
        try {
            const state = {
                usedNames: Array.from(usedNames)
            };
            
            await fetch(`${API_URL}/state`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(state)
            });
        } catch (error) {
            console.error('保存状态失败:', error);
        }
    }

    function createNameItem(nameData) {
        const div = document.createElement('div');
        div.className = 'name-item';
        
        const nameContent = document.createElement('div');
        nameContent.className = 'name-content';
        
        if (typeof nameData === 'object' && nameData.avatar) {
            const avatar = document.createElement('img');
            avatar.className = 'avatar';
            avatar.src = nameData.avatar;
            avatar.alt = nameData.name;
            avatar.onerror = function() {
                this.src = 'assets/default-avatar.png';
            };
            nameContent.appendChild(avatar);
        }
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = typeof nameData === 'object' ? nameData.name : nameData;
        nameContent.appendChild(nameSpan);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = '删除';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const name = typeof nameData === 'object' ? nameData.name : nameData;
            if (confirm(`确定要删除 ${name} 吗？`)) {
                try {
                    // 直接从本地删除，不调用API
                    names = names.filter(n => (typeof n === 'object' ? n.name : n) !== name);
                    usedNames.delete(name);
                    updateLists();
                    updateSyncStatus('删除成功');
                    // 保存更改
                    await saveToServer();
                } catch (error) {
                    console.error('删除失败:', error);
                    alert('删除失败，请重试');
                    updateSyncStatus('删除失败');
                }
            }
        };
        
        div.appendChild(nameContent);
        div.appendChild(deleteBtn);
        div.draggable = true;
        
        div.addEventListener('dragstart', function(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', typeof nameData === 'object' ? nameData.name : nameData);
        });
        
        div.addEventListener('dragend', function(e) {
            e.target.classList.remove('dragging');
        });
        
        return div;
    }

    function updateLists() {
        const remainingList = document.getElementById('remainingList');
        const usedList = document.getElementById('usedList');
        
        remainingList.innerHTML = '';
        usedList.innerHTML = '';
        
        // 更新待抽取名单
        names.filter(name => !usedNames.has(typeof name === 'object' ? name.name : name))
            .forEach(name => {
                remainingList.appendChild(createNameItem(name));
            });
        
        // 更新已抽取名单
        Array.from(usedNames).forEach(name => {
            const nameData = names.find(n => (typeof n === 'object' ? n.name : n) === name);
            usedList.appendChild(createNameItem(nameData || name));
        });
    }

    function setupDragAndDrop() {
        const lists = [
            document.getElementById('remainingList'),
            document.getElementById('usedList')
        ];
        
        lists.forEach(list => {
            list.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            list.addEventListener('drop', function(e) {
                e.preventDefault();
                const name = e.dataTransfer.getData('text/plain');
                
                if (this.id === 'usedList') {
                    usedNames.add(name);
                } else {
                    usedNames.delete(name);
                }
                
                updateLists();
                saveToServer();  // 保存拖拽后的状态
            });
        });
    }

    function updateResult(nameData) {
        const resultElement = document.getElementById('result');
        const resultAvatar = document.getElementById('resultAvatar');
        const resultNameDiv = resultElement.querySelector('.result-name');
        
        if (nameData === null) {
            resultAvatar.style.display = 'none';
            resultNameDiv.textContent = '等待抽取...';
            saveToServer();  // 保存状态
            return;
        }
        
        if (typeof nameData === 'object' && nameData.avatar) {
            resultAvatar.src = nameData.avatar;
            resultAvatar.style.display = 'block';
            resultNameDiv.textContent = nameData.name;
        } else {
            resultAvatar.style.display = 'none';
            resultNameDiv.textContent = nameData;
        }
        saveToServer();  // 保存状态
    }

    // 修改原有的 startRoll 函数
    async function startRoll() {
        if (isRolling) return;
        
        const remainingList = document.getElementById('remainingList');
        if (remainingList.children.length === 0) {
            alert('没有可抽取的名字了！');
            return;
        }
        
        isRolling = true;
        const result = document.querySelector('#result .result-name');
        const resultAvatar = document.getElementById('resultAvatar');
        const rollButton = document.querySelector('.roll-button');
        rollButton.disabled = true;
        
        try {
            let count = 0;
            const maxCount = 20;
            const interval = setInterval(async () => {
                try {
                    const remainingNames = names.filter(n => !usedNames.has(typeof n === 'object' ? n.name : n));
                    if (remainingNames.length === 0) {
                        clearInterval(interval);
                        throw new Error('没有可抽取的名字了！');
                    }
                    
                    const randomIndex = Math.floor(Math.random() * remainingNames.length);
                    const selectedName = remainingNames[randomIndex];
                    
                    result.textContent = typeof selectedName === 'object' ? selectedName.name : selectedName;
                    if (typeof selectedName === 'object' && selectedName.avatar) {
                        resultAvatar.src = selectedName.avatar;
                        resultAvatar.style.display = 'block';
                    } else {
                        resultAvatar.style.display = 'none';
                    }
                    
                    count++;
                    if (count >= maxCount) {
                        clearInterval(interval);
                        isRolling = false;
                        rollButton.disabled = false;
                        
                        // 更新名单状态
                        const finalName = typeof selectedName === 'object' ? selectedName.name : selectedName;
                        usedNames.add(finalName);
                        
                        // 保存到LeanCloud
                        await saveResult(finalName, typeof selectedName === 'object' ? selectedName.avatar : null);
                        
                        // 更新UI
                        updateLists();
                        const usedList = document.getElementById('usedList');
                        usedList.scrollTop = 0;
                        
                        // 保存状态
                        await saveToServer();
                    }
                } catch (error) {
                    console.error('滚动过程中出错:', error);
                    clearInterval(interval);
                    isRolling = false;
                    rollButton.disabled = false;
                    updateSyncStatus('抽取过程出错');
                }
            }, 100);
        } catch (error) {
            console.error('启动抽取过程失败:', error);
            isRolling = false;
            rollButton.disabled = false;
            updateSyncStatus('启动抽取失败');
        }
    }

    async function addNewName() {
        const input = document.getElementById('newNameInput');
        const newName = input.value.trim();
        const avatarInput = document.getElementById('avatarInput');
        
        if (!newName) {
            alert('请输入名字！');
            return;
        }
        
        if (names.some(n => (typeof n === 'object' ? n.name : n) === newName)) {
            alert('该名字已存在！');
            return;
        }

        let avatarPath = null;
        if (avatarInput.files && avatarInput.files[0]) {
            try {
                const file = avatarInput.files[0];
                const reader = new FileReader();
                
                // 使用Promise包装FileReader
                avatarPath = await new Promise((resolve, reject) => {
                    reader.onload = function(e) {
                        resolve(e.target.result); // 直接使用Base64数据
                    };
                    reader.onerror = function(e) {
                        reject(new Error('头像读取失败'));
                    };
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('头像处理失败:', error);
                alert('头像处理失败，将使用默认头像');
                avatarPath = null;
            }
        }
        
        // 创建新的名字对象
        const newNameObj = {
            name: newName,
            avatar: avatarPath || 'assets/default-avatar.png'
        };
        
        // 添加到名单中
        names.push(newNameObj);
        
        // 清空输入框和预览
        input.value = '';
        avatarInput.value = '';
        document.getElementById('avatarPreview').style.display = 'none';
        
        // 更新列表显示
        updateLists();
        
        // 保存到服务器
        await saveToServer();
        updateSyncStatus('添加成功');
    }

    // 添加头像预览功能
    document.getElementById('avatarInput').addEventListener('change', function(e) {
        const preview = document.getElementById('avatarPreview');
        const file = e.target.files[0];
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.onerror = function(e) {
                console.error('头像预览失败:', e);
                preview.style.display = 'none';
                alert('头像预览失败，请重试');
            }
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    });

    // 修改重置函数
    function resetList() {
        if (isRolling) return;
        if (!confirm('确定要重置名单吗？这将清空已抽取的记录。')) return;
        
        names = [...INITIAL_NAMES];
        usedNames.clear();
        updateLists();
        updateResult(null);
        saveToServer();
    }

    // 点击模态框外部时关闭
    window.onclick = function(event) {
        const saveModal = document.getElementById('saveModal');
        if (event.target == saveModal) {
            saveModal.classList.remove('show');
        }
    }

    // 添加主题切换功能
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    // 在页面加载时恢复保存的主题
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        // 如果没有保存的主题或者是light主题，都设置为dark主题
        if (!savedTheme || savedTheme === 'light') {
            localStorage.setItem('theme', 'dark');
        }
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme'));
    }

    // 添加更新日期显示的函数
    function updateDateDisplay() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const dateStr = now.toLocaleDateString('zh-CN', options);
        document.getElementById('dateDisplay').textContent = dateStr;
    }

    // 修改显示保存对话框的函数
    function showSaveModal() {
        const modal = document.getElementById('saveModal');
        const stateDisplay = document.getElementById('stateDisplay');
        const state = {
            usedNames: Array.from(usedNames),
            lastResult: document.querySelector('.result-name').textContent,
            lastAvatarSrc: document.getElementById('resultAvatar').src,
            lastAvatarDisplay: document.getElementById('resultAvatar').style.display
        };
        
        stateDisplay.textContent = 'const SAVED_STATE = ' + JSON.stringify(state, null, 2) + ';';
        modal.classList.add('show');
    }

    // 修改关闭对话框的函数
    function closeModal() {
        document.getElementById('saveModal').classList.remove('show');
    }

    // 修改同步状态显示函数
    function updateSyncStatus(message) {
        const syncStatus = document.getElementById('syncStatus');
        syncStatus.textContent = `同步状态: ${message}`;
        
        // 添加视觉反馈
        syncStatus.style.opacity = '1';
        syncStatus.style.backgroundColor = message.includes('失败') ? '#ff4d4f' : '#52c41a';
        syncStatus.style.color = '#ffffff';
        
        // 3秒后恢复默认状态
        setTimeout(() => {
            syncStatus.textContent = '同步状态: 已连接';
            syncStatus.style.backgroundColor = 'var(--card-bg)';
            syncStatus.style.color = 'var(--text-color)';
            syncStatus.style.opacity = '0.8';
        }, 3000);
    }
    </script>
    <style>
        :root[data-theme="light"] {
            --bg-color: #f0f2f5;
            --text-color: #000000;
            --card-bg: white;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --item-bg: #f8f8f8;
            --item-hover: #e6f7ff;
            --item-drag: #bae7ff;
            --border-color: #d9d9d9;
            --result-color: #909090;
            --start-button-bg: #ffd700;
            --start-button-hover: #ffed4a;
            --result-text-color: #000000;
        }

        :root[data-theme="dark"] {
            --bg-color: #1f1f1f;
            --text-color: #ffffff;
            --card-bg: #2d2d2d;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.3);
            --item-bg: #3d3d3d;
            --item-hover: #4a4a4a;
            --item-drag: #505050;
            --border-color: #404040;
            --result-color: #606060;
            --start-button-bg: #ffd700;
            --start-button-hover: #ffed4a;
            --result-text-color: #ffffff;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .container {
            text-align: center;
            padding: 20px;
            max-width: 800px;
            width: 100%;
        }
        .lists-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .list-column {
            flex: 1;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        .list-column h3 {
            font-size: 1.1em;
            margin: 0 0 8px 0;
            opacity: 0.9;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
        }
        .result-container {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            margin: 20px 0 30px 0;
            box-shadow: var(--card-shadow);
            border: 2px solid var(--start-button-bg);
        }
        #result {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            font-size: 3.2em;
            margin: 25px 0;
            min-height: 120px;
            font-weight: bold;
        }
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }
        button {
            padding: 12px 24px;
            font-size: 1.1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .roll-button {
            padding: 15px 40px;
            font-size: 1.3em;
            background-color: var(--start-button-bg);
            color: #000000;
            border: none;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .roll-button:hover {
            background-color: var(--start-button-hover);
            color: #000000;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .reset-button {
            padding: 12px 24px;
            font-size: 0.9em;
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            opacity: 0.7;
        }
        .reset-button:hover {
            background-color: var(--item-bg);
            opacity: 1;
        }
        button:hover {
            opacity: 0.8;
        }
        @keyframes roll {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .rolling {
            animation: roll 0.1s infinite;
        }
        .name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin: 4px 0;
            background: var(--item-bg);
            color: var(--text-color);
            border-radius: 4px;
            cursor: move;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .name-item:hover {
            background: var(--item-hover);
        }
        
        .name-item.dragging {
            opacity: 0.5;
            background: var(--item-drag);
        }
        
        .name-list {
            min-height: 150px;
            max-height: 300px;
            padding: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow-y: auto;
        }
        
        textarea {
            display: none;  /* 隐藏文本框 */
        }
        
        .delete-btn {
            padding: 2px 8px;
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-name-container {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .add-name-input {
            width: 120px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .add-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar-preview {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--item-bg);
            display: none;
            margin-right: 5px;
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .upload-btn {
            padding: 8px 16px;
            background: var(--item-bg);
            color: var(--text-color);
            border: 2px solid var(--result-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-btn {
            padding: 8px 16px;
            background: var(--start-button-bg);
            color: #000000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-btn:hover {
            background: var(--start-button-hover);
            transform: translateY(-1px);
        }

        .name-content {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .result-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }

        .result-name {
            margin: 0;
            color: var(--result-text-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 2px;
        }

        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-switch:hover {
            opacity: 0.8;
        }

        .theme-switch svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
        }

        /* 深色模式时显示月亮图标 */
        :root[data-theme="dark"] .theme-switch .sun-icon {
            display: none;
        }
        :root[data-theme="dark"] .theme-switch .moon-icon {
            display: block;
        }

        /* 浅色模式时显示太阳图标 */
        :root[data-theme="light"] .theme-switch .sun-icon {
            display: block;
        }
        :root[data-theme="light"] .theme-switch .moon-icon {
            display: none;
        }

        .date-display {
            position: fixed;
            top: 20px;
            right: 80px;
            padding: 8px 16px;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin: 0;
            opacity: 0.8;
        }

        .save-button {
            display: none;  /* 隐藏保存状态按钮 */
        }

        .modal {
            display: none;  /* 默认隐藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal.show {  /* 添加显示类 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            position: relative;
            background: var(--card-bg);
            padding: 20px;
            width: 70%;
            max-width: 600px;
            border-radius: 8px;
            color: var(--text-color);
            box-shadow: var(--card-shadow);
            margin: 0;
        }

        .state-display {
            background: var(--item-bg);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .instructions {
            margin: 15px 0;
            line-height: 1.5;
            text-align: left;
        }

        .title-container {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .title-container h1 {
            margin: 0;
        }

        .version-tag {
            font-size: 0.7em;
            font-weight: 300;
            opacity: 0.8;
            color: var(--text-color);
        }

        /* 添加同步状态指示器样式 */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 4px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* 添加历史记录样式 */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: var(--item-bg);
            border-radius: 4px;
        }
        
        .history-item {
            padding: 10px;
            margin: 5px 0;
            background: var(--card-bg);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        
        .history-item .time {
            font-size: 0.8em;
            color: var(--result-color);
        }

        /* 添加自定义滚动条样式 */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <button class="theme-switch" onclick="toggleTheme()">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/>
        </svg>
    </button>
    <div class="date-display" id="dateDisplay"></div>
    <div class="sync-status" id="syncStatus">同步状态: 已连接</div>

    <div class="container">
        <div class="title-container">
            <h1>运营课摇人</h1>
            <span class="version-tag">5.0 Ultra</span>
        </div>
        
        <div class="result-container">
            <div id="result">
                <img class="result-avatar" id="resultAvatar" src="" alt="">
                <div class="result-name">等待抽取...</div>
            </div>
            <div class="buttons">
                <button class="roll-button" onclick="startRoll()">开始抽取</button>
                <button class="reset-button" onclick="resetList()">重置名单</button>
            </div>
        </div>

        <div class="lists-container">
            <div class="list-column">
                <h3>待抽取名单</h3>
                <div id="remainingList" class="name-list custom-scrollbar"></div>
                <div class="add-name-container">
                    <input type="text" class="add-name-input" id="newNameInput" placeholder="输入新名字">
                    <img id="avatarPreview" class="avatar-preview">
                    <div class="file-input-container">
                        <button class="upload-btn">选择头像</button>
                        <input type="file" id="avatarInput" accept="image/*">
                    </div>
                    <button class="add-btn" onclick="addNewName()">添加</button>
                </div>
            </div>
            
            <div class="list-column">
                <h3>已抽取名单</h3>
                <div id="usedList" class="name-list custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <script>
    // 全局变量和常量声明
    const INITIAL_NAMES = [
        { name: "梁晓珍", avatar: "assets/avatars/梁晓珍.png" },
        { name: "常鸿祥", avatar: "assets/avatars/常鸿祥.png" },
        { name: "韩烁", avatar: "assets/avatars/韩烁.png" },
        { name: "荆文姗", avatar: "assets/avatars/荆文姗.png" },
        { name: "励艳丽", avatar: "assets/avatars/励艳丽.png" },
        { name: "吕飞", avatar: "assets/avatars/吕飞.png" },
        { name: "邱宇宁", avatar: "assets/avatars/邱宇宁.png" },
        { name: "任蒙龙", avatar: "assets/avatars/任蒙龙.png" },
        { name: "王耀旭", avatar: "assets/avatars/王耀旭.png" },
        { name: "喻言", avatar: "assets/avatars/喻言.png" },
        { name: "张华珍", avatar: "assets/avatars/张华珍.png" },
        { name: "张小莲", avatar: "assets/avatars/张小莲.png" }
    ];

    const DB_NAME = 'YaorenDB';
    const DB_VERSION = 1;
    const API_URL = '/api';
    const MAX_RETRIES = 3;
    const SYNC_INTERVAL = 1000;

    let names = [...INITIAL_NAMES];
    let usedNames = new Set();
    let isRolling = false;
    let rollInterval;
    let db;
    let retryCount = 0;
    let lastSyncTime = 0;

    // 强制使用 HTTPS
    if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
        window.location.href = window.location.href.replace('http:', 'https:');
    }

    // ... rest of the existing JavaScript code ...
    </script>
</body>
</html> 